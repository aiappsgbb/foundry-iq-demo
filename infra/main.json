{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.30.3.12046",
      "templateHash": "7328572534496236210"
    }
  },
  "parameters": {
    "baseName": {
      "type": "string",
      "defaultValue": "aikb",
      "minLength": 3,
      "maxLength": 10,
      "metadata": {
        "description": "Base name for all resources (will be used to generate unique names)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "repositoryUrl": {
      "type": "string",
      "defaultValue": "https://github.com/farzad528/azure-ai-search-knowledge-retrieval-demo",
      "metadata": {
        "description": "GitHub repository URL for Static Web App"
      }
    },
    "branch": {
      "type": "string",
      "defaultValue": "main",
      "metadata": {
        "description": "GitHub repository branch"
      }
    },
    "repositoryToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "GitHub repository token for Static Web App deployment"
      }
    },
    "deploySampleData": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy sample data (hotels index and Responsible AI PDF)"
      }
    },
    "chatModelName": {
      "type": "string",
      "defaultValue": "gpt-4o-mini",
      "allowedValues": [
        "gpt-4o",
        "gpt-4o-mini",
        "gpt-4.1-nano",
        "gpt-4.1-mini",
        "gpt-4.1",
        "gpt-5",
        "gpt-5-mini",
        "gpt-5-nano"
      ],
      "metadata": {
        "description": "Chat model to deploy"
      }
    },
    "embeddingModelName": {
      "type": "string",
      "defaultValue": "text-embedding-3-small",
      "allowedValues": [
        "text-embedding-ada-002",
        "text-embedding-3-small",
        "text-embedding-3-large"
      ],
      "metadata": {
        "description": "Embedding model to deploy"
      }
    }
  },
  "variables": {
    "skuMap": {
      "dev": {
        "search": "basic",
        "storage": "Standard_LRS",
        "staticWebApp": "Standard"
      },
      "staging": {
        "search": "standard",
        "storage": "Standard_LRS",
        "staticWebApp": "Standard"
      },
      "prod": {
        "search": "standard",
        "storage": "Standard_GRS",
        "staticWebApp": "Standard"
      }
    },
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "resourceNames": {
      "search": "[format('{0}-search-{1}', parameters('baseName'), variables('uniqueSuffix'))]",
      "openai": "[format('{0}-openai-{1}', parameters('baseName'), variables('uniqueSuffix'))]",
      "storage": "[toLower(format('st{0}{1}', parameters('baseName'), take(variables('uniqueSuffix'), sub(sub(24, 2), length(parameters('baseName'))))))]",
      "hub": "[format('{0}-hub-{1}', parameters('baseName'), variables('uniqueSuffix'))]",
      "project": "[format('{0}-prj-{1}', parameters('baseName'), variables('uniqueSuffix'))]",
      "staticWebApp": "[format('{0}-web-{1}', parameters('baseName'), variables('uniqueSuffix'))]",
      "logAnalytics": "[format('{0}-{1}-law', parameters('baseName'), variables('uniqueSuffix'))]",
      "appInsights": "[format('{0}-{1}-appi', parameters('baseName'), variables('uniqueSuffix'))]"
    },
    "tags": {
      "environment": "[parameters('environment')]",
      "solution": "Azure AI Search Knowledge Retrieval",
      "managedBy": "Bicep"
    },
    "chatModelConfig": {
      "gpt-4o": {
        "version": "2024-08-06",
        "capacity": 30
      },
      "gpt-4o-mini": {
        "version": "2024-07-18",
        "capacity": 30
      },
      "gpt-4.1-nano": {
        "version": "2024-11-01",
        "capacity": 30
      },
      "gpt-4.1-mini": {
        "version": "2024-11-01",
        "capacity": 30
      },
      "gpt-4.1": {
        "version": "2024-11-01",
        "capacity": 30
      },
      "gpt-5": {
        "version": "latest",
        "capacity": 30
      },
      "gpt-5-mini": {
        "version": "latest",
        "capacity": 30
      },
      "gpt-5-nano": {
        "version": "latest",
        "capacity": 30
      }
    },
    "embeddingModelConfig": {
      "text-embedding-ada-002": {
        "version": "2",
        "capacity": 120
      },
      "text-embedding-3-small": {
        "version": "1",
        "capacity": 20
      },
      "text-embedding-3-large": {
        "version": "1",
        "capacity": 20
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy-search",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "searchServiceName": {
            "value": "[variables('resourceNames').search]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[variables('skuMap')[parameters('environment')].search]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.3.12046",
              "templateHash": "10837400339155421844"
            }
          },
          "parameters": {
            "searchServiceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Azure AI Search service"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the search service"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "basic",
              "allowedValues": [
                "basic",
                "standard",
                "standard2",
                "standard3",
                "storage_optimized_l1",
                "storage_optimized_l2"
              ],
              "metadata": {
                "description": "SKU for the search service"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the search service"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2023-11-01",
              "name": "[parameters('searchServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "hostingMode": "default",
                "partitionCount": 1,
                "replicaCount": 1,
                "publicNetworkAccess": "enabled",
                "semanticSearch": "free",
                "authOptions": {
                  "aadOrApiKey": {
                    "aadAuthFailureMode": "http401WithBearerChallenge"
                  }
                }
              }
            }
          ],
          "outputs": {
            "searchServiceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Search/searchServices', parameters('searchServiceName'))]"
            },
            "searchServiceName": {
              "type": "string",
              "value": "[parameters('searchServiceName')]"
            },
            "searchEndpoint": {
              "type": "string",
              "value": "[format('https://{0}.search.windows.net', parameters('searchServiceName'))]"
            },
            "searchAdminKey": {
              "type": "string",
              "value": "[listAdminKeys(resourceId('Microsoft.Search/searchServices', parameters('searchServiceName')), '2023-11-01').primaryKey]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy-storage",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('resourceNames').storage]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[variables('skuMap')[parameters('environment')].storage]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "sampleDataContainerName": {
            "value": "sample-documents"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.3.12046",
              "templateHash": "2107858829095817671"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Name of the storage account"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the storage account"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Standard_ZRS",
                "Premium_LRS"
              ],
              "metadata": {
                "description": "SKU for the storage account"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the storage account"
              }
            },
            "sampleDataContainerName": {
              "type": "string",
              "defaultValue": "sample-documents",
              "metadata": {
                "description": "Container name for sample data"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true
                    },
                    "file": {
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', parameters('sampleDataContainerName'))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountPrimaryEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').primaryEndpoints.blob]"
            },
            "sampleDataContainerName": {
              "type": "string",
              "value": "[parameters('sampleDataContainerName')]"
            },
            "storageAccountKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value]"
            },
            "storageConnectionString": {
              "type": "string",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-01-01').keys[0].value, environment().suffixes.storage)]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy-foundry",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "hubName": {
            "value": "[variables('resourceNames').hub]"
          },
          "projectName": {
            "value": "[variables('resourceNames').project]"
          },
          "aiServicesName": {
            "value": "[variables('resourceNames').openai]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "searchResourceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-search'), '2022-09-01').outputs.searchServiceId.value]"
          },
          "storageAccountId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-storage'), '2022-09-01').outputs.storageAccountId.value]"
          },
          "chatModelName": {
            "value": "[parameters('chatModelName')]"
          },
          "embeddingModelName": {
            "value": "[parameters('embeddingModelName')]"
          },
          "chatCapacity": {
            "value": "[variables('chatModelConfig')[parameters('chatModelName')].capacity]"
          },
          "embeddingCapacity": {
            "value": "[variables('embeddingModelConfig')[parameters('embeddingModelName')].capacity]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.3.12046",
              "templateHash": "12378096488353200206"
            }
          },
          "parameters": {
            "hubName": {
              "type": "string",
              "metadata": {
                "description": "Name of the AI Foundry hub"
              }
            },
            "projectName": {
              "type": "string",
              "metadata": {
                "description": "Name of the AI Foundry project"
              }
            },
            "aiServicesName": {
              "type": "string",
              "defaultValue": "[format('{0}-ais', parameters('hubName'))]",
              "metadata": {
                "description": "Name of the AI Services account (hosts model deployments)"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for AI Foundry resources"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for AI Foundry resources"
              }
            },
            "searchResourceId": {
              "type": "string",
              "metadata": {
                "description": "Search resource ID to connect"
              }
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage account resource ID to connect"
              }
            },
            "chatModelName": {
              "type": "string",
              "defaultValue": "gpt-4.1-mini",
              "allowedValues": [
                "gpt-4o",
                "gpt-4o-mini",
                "gpt-4.1-nano",
                "gpt-4.1-mini",
                "gpt-4.1",
                "gpt-5-nano",
                "gpt-5-mini",
                "gpt-5"
              ],
              "metadata": {
                "description": "Chat model to deploy"
              }
            },
            "embeddingModelName": {
              "type": "string",
              "defaultValue": "text-embedding-3-large",
              "allowedValues": [
                "text-embedding-ada-002",
                "text-embedding-3-small",
                "text-embedding-3-large"
              ],
              "metadata": {
                "description": "Embedding model to deploy"
              }
            },
            "chatCapacity": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Chat model capacity (TPM in thousands)"
              }
            },
            "embeddingCapacity": {
              "type": "int",
              "defaultValue": 20,
              "metadata": {
                "description": "Embedding model capacity (TPM in thousands)"
              }
            }
          },
          "variables": {
            "chatModelConfig": {
              "gpt-4o": {
                "version": "2024-08-06"
              },
              "gpt-4o-mini": {
                "version": "2024-07-18"
              },
              "gpt-4.1-nano": {
                "version": "2024-11-01"
              },
              "gpt-4.1-mini": {
                "version": "2024-11-01"
              },
              "gpt-4.1": {
                "version": "2024-11-01"
              },
              "gpt-5-nano": {
                "version": "2025-01-01"
              },
              "gpt-5-mini": {
                "version": "2025-01-01"
              },
              "gpt-5": {
                "version": "2025-01-01"
              }
            },
            "embeddingModelConfig": {
              "text-embedding-ada-002": {
                "version": "2"
              },
              "text-embedding-3-small": {
                "version": "1"
              },
              "text-embedding-3-large": {
                "version": "1"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2024-10-01",
              "name": "[parameters('aiServicesName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AIServices",
              "sku": {
                "name": "S0"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "customSubDomainName": "[parameters('aiServicesName')]",
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow"
                },
                "disableLocalAuth": false
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('aiServicesName'), parameters('embeddingModelName'))]",
              "sku": {
                "name": "Standard",
                "capacity": "[parameters('embeddingCapacity')]"
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('embeddingModelName')]",
                  "version": "[variables('embeddingModelConfig')[parameters('embeddingModelName')].version]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2024-10-01",
              "name": "[format('{0}/{1}', parameters('aiServicesName'), parameters('chatModelName'))]",
              "sku": {
                "name": "Standard",
                "capacity": "[parameters('chatCapacity')]"
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('chatModelName')]",
                  "version": "[variables('chatModelConfig')[parameters('chatModelName')].version]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', parameters('aiServicesName'), parameters('embeddingModelName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-04-01",
              "name": "[parameters('hubName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "kind": "Hub",
              "properties": {
                "description": "Azure AI Foundry Hub for Knowledge Retrieval Demo",
                "friendlyName": "[parameters('hubName')]",
                "storageAccount": "[parameters('storageAccountId')]",
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2024-04-01",
              "name": "[parameters('projectName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "kind": "Project",
              "properties": {
                "description": "Azure AI Foundry Project for Agentic RAG",
                "friendlyName": "[parameters('projectName')]",
                "hubResourceId": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('hubName'))]",
                "publicNetworkAccess": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('hubName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces/connections",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', parameters('projectName'), 'aiservices-connection')]",
              "properties": {
                "category": "AzureOpenAI",
                "target": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]",
                "authType": "AAD",
                "isSharedToAll": true,
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('projectName'))]",
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"
              ]
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces/connections",
              "apiVersion": "2024-04-01",
              "name": "[format('{0}/{1}', parameters('projectName'), 'search-connection')]",
              "properties": {
                "category": "CognitiveSearch",
                "target": "[parameters('searchResourceId')]",
                "authType": "AAD",
                "isSharedToAll": true,
                "metadata": {
                  "ResourceId": "[parameters('searchResourceId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('projectName'))]"
              ]
            }
          ],
          "outputs": {
            "hubId": {
              "type": "string",
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('hubName'))]"
            },
            "hubName": {
              "type": "string",
              "value": "[parameters('hubName')]"
            },
            "projectId": {
              "type": "string",
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('projectName'))]"
            },
            "projectName": {
              "type": "string",
              "value": "[parameters('projectName')]"
            },
            "projectEndpoint": {
              "type": "string",
              "value": "[format('https://{0}.{1}.api.azureml.ms', reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('projectName')), '2024-04-01').workspaceId, parameters('location'))]"
            },
            "hubPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('hubName')), '2024-04-01', 'full').identity.principalId]"
            },
            "projectPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('projectName')), '2024-04-01', 'full').identity.principalId]"
            },
            "aiServicesId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName'))]"
            },
            "aiServicesName": {
              "type": "string",
              "value": "[parameters('aiServicesName')]"
            },
            "aiServicesEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), '2024-10-01').endpoint]"
            },
            "aiServicesKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', parameters('aiServicesName')), '2024-10-01').key1]"
            },
            "embeddingDeploymentName": {
              "type": "string",
              "value": "[parameters('embeddingModelName')]"
            },
            "chatDeploymentName": {
              "type": "string",
              "value": "[parameters('chatModelName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-search')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-storage')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy-monitoring",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseName": {
            "value": "[format('{0}-{1}', parameters('baseName'), variables('uniqueSuffix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "retentionInDays": "[if(equals(parameters('environment'), 'prod'), createObject('value', 90), createObject('value', 30))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.3.12046",
              "templateHash": "15662434462407148951"
            }
          },
          "parameters": {
            "baseName": {
              "type": "string",
              "metadata": {
                "description": "Base name for monitoring resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for all resources"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Retention period in days for Log Analytics"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}-law', parameters('baseName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[format('{0}-appi', parameters('baseName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('baseName')))]",
                "RetentionInDays": 90,
                "DisableIpMasking": false,
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('baseName')))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-law', parameters('baseName')))]"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[format('{0}-law', parameters('baseName'))]"
            },
            "applicationInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', format('{0}-appi', parameters('baseName')))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "value": "[format('{0}-appi', parameters('baseName'))]"
            },
            "applicationInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', format('{0}-appi', parameters('baseName'))), '2020-02-02').ConnectionString]"
            },
            "applicationInsightsInstrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', format('{0}-appi', parameters('baseName'))), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy-staticwebapp",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "staticWebAppName": {
            "value": "[variables('resourceNames').staticWebApp]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[variables('skuMap')[parameters('environment')].staticWebApp]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "repositoryUrl": {
            "value": "[parameters('repositoryUrl')]"
          },
          "branch": {
            "value": "[parameters('branch')]"
          },
          "repositoryToken": {
            "value": "[parameters('repositoryToken')]"
          },
          "serviceName": {
            "value": "web"
          },
          "azureSearchEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-search'), '2022-09-01').outputs.searchEndpoint.value]"
          },
          "azureSearchApiKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-search'), '2022-09-01').outputs.searchAdminKey.value]"
          },
          "azureSearchApiVersion": {
            "value": "2025-11-01-preview"
          },
          "azureOpenAIEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.aiServicesEndpoint.value]"
          },
          "azureOpenAIApiKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.aiServicesKey.value]"
          },
          "foundryProjectEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.projectEndpoint.value]"
          },
          "foundryApiKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.aiServicesKey.value]"
          },
          "foundryProjectName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.projectName.value]"
          },
          "azureSubscriptionId": {
            "value": "[subscription().subscriptionId]"
          },
          "azureResourceGroup": {
            "value": "[resourceGroup().name]"
          },
          "applicationInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-monitoring'), '2022-09-01').outputs.applicationInsightsConnectionString.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.3.12046",
              "templateHash": "7682591045540501531"
            }
          },
          "parameters": {
            "staticWebAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the static web app"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for the static web app"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "allowedValues": [
                "Free",
                "Standard"
              ],
              "metadata": {
                "description": "SKU for the static web app"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the static web app"
              }
            },
            "serviceName": {
              "type": "string",
              "defaultValue": "web",
              "metadata": {
                "description": "Azure Developer CLI service name for deployment targeting"
              }
            },
            "repositoryUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Repository URL"
              }
            },
            "branch": {
              "type": "string",
              "defaultValue": "main",
              "metadata": {
                "description": "Branch name"
              }
            },
            "repositoryToken": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Repository token (optional)"
              }
            },
            "buildProperties": {
              "type": "object",
              "defaultValue": {
                "appLocation": "/",
                "apiLocation": "",
                "outputLocation": "",
                "appBuildCommand": "npm run build",
                "apiBuildCommand": ""
              },
              "metadata": {
                "description": "Build properties"
              }
            },
            "azureSearchEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AI Search endpoint URL"
              }
            },
            "azureSearchApiKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Azure AI Search API key"
              }
            },
            "azureSearchApiVersion": {
              "type": "string",
              "defaultValue": "2025-11-01-preview",
              "metadata": {
                "description": "Azure AI Search API version"
              }
            },
            "azureOpenAIEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure OpenAI endpoint URL (e.g., https://{name}.openai.azure.com)"
              }
            },
            "azureOpenAIApiKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Azure OpenAI API key"
              }
            },
            "foundryProjectEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Foundry Project endpoint URL"
              }
            },
            "foundryApiKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Foundry API key (for Azure OpenAI access) - DEPRECATED: use azureOpenAIApiKey"
              }
            },
            "foundryProjectName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Foundry Project name"
              }
            },
            "azureSubscriptionId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Subscription ID"
              }
            },
            "azureResourceGroup": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure Resource Group name"
              }
            },
            "applicationInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('staticWebAppName')]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-service-name', parameters('serviceName')))]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "[parameters('sku')]"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "repositoryUrl": "[parameters('repositoryUrl')]",
                "branch": "[parameters('branch')]",
                "repositoryToken": "[parameters('repositoryToken')]",
                "buildProperties": "[parameters('buildProperties')]",
                "provider": "GitHub",
                "stagingEnvironmentPolicy": "Enabled",
                "allowConfigFileUpdates": true,
                "enterpriseGradeCdnStatus": "Disabled"
              }
            },
            {
              "type": "Microsoft.Web/staticSites/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('staticWebAppName'), 'appsettings')]",
              "properties": {
                "AZURE_SEARCH_ENDPOINT": "[parameters('azureSearchEndpoint')]",
                "AZURE_SEARCH_API_KEY": "[parameters('azureSearchApiKey')]",
                "AZURE_SEARCH_API_VERSION": "[parameters('azureSearchApiVersion')]",
                "NEXT_PUBLIC_SEARCH_ENDPOINT": "[parameters('azureSearchEndpoint')]",
                "NEXT_PUBLIC_AZURE_SEARCH_API_VERSION": "[parameters('azureSearchApiVersion')]",
                "AZURE_OPENAI_ENDPOINT": "[parameters('azureOpenAIEndpoint')]",
                "AZURE_OPENAI_API_KEY": "[if(not(empty(parameters('azureOpenAIApiKey'))), parameters('azureOpenAIApiKey'), parameters('foundryApiKey'))]",
                "NEXT_PUBLIC_AZURE_OPENAI_ENDPOINT": "[parameters('azureOpenAIEndpoint')]",
                "FOUNDRY_PROJECT_ENDPOINT": "[parameters('foundryProjectEndpoint')]",
                "FOUNDRY_API_KEY": "[if(not(empty(parameters('azureOpenAIApiKey'))), parameters('azureOpenAIApiKey'), parameters('foundryApiKey'))]",
                "FOUNDRY_PROJECT_NAME": "[parameters('foundryProjectName')]",
                "NEXT_PUBLIC_FOUNDRY_ENDPOINT": "[parameters('foundryProjectEndpoint')]",
                "AZURE_SUBSCRIPTION_ID": "[parameters('azureSubscriptionId')]",
                "AZURE_RESOURCE_GROUP": "[parameters('azureResourceGroup')]",
                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[parameters('applicationInsightsConnectionString')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName'))]"
              ]
            }
          ],
          "outputs": {
            "staticWebAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName'))]"
            },
            "staticWebAppName": {
              "type": "string",
              "value": "[parameters('staticWebAppName')]"
            },
            "staticWebAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName')), '2023-01-01').defaultHostname)]"
            },
            "staticWebAppPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/staticSites', parameters('staticWebAppName')), '2023-01-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'deploy-foundry')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-monitoring')]",
        "[resourceId('Microsoft.Resources/deployments', 'deploy-search')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "location": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "searchEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-search'), '2022-09-01').outputs.searchEndpoint.value]"
    },
    "searchServiceName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-search'), '2022-09-01').outputs.searchServiceName.value]"
    },
    "searchAdminKey": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-search'), '2022-09-01').outputs.searchAdminKey.value]"
    },
    "openAIEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.aiServicesEndpoint.value]"
    },
    "openAIKey": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.aiServicesKey.value]"
    },
    "embeddingDeploymentName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.embeddingDeploymentName.value]"
    },
    "chatDeploymentName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.chatDeploymentName.value]"
    },
    "aiServicesName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.aiServicesName.value]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-storage'), '2022-09-01').outputs.storageAccountName.value]"
    },
    "storageConnectionString": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-storage'), '2022-09-01').outputs.storageConnectionString.value]"
    },
    "sampleDataContainerName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-storage'), '2022-09-01').outputs.sampleDataContainerName.value]"
    },
    "foundryProjectEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.projectEndpoint.value]"
    },
    "foundryProjectName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.projectName.value]"
    },
    "foundryHubName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.hubName.value]"
    },
    "staticWebAppUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-staticwebapp'), '2022-09-01').outputs.staticWebAppUrl.value]"
    },
    "staticWebAppName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-staticwebapp'), '2022-09-01').outputs.staticWebAppName.value]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-monitoring'), '2022-09-01').outputs.logAnalyticsWorkspaceId.value]"
    },
    "applicationInsightsName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-monitoring'), '2022-09-01').outputs.applicationInsightsName.value]"
    },
    "applicationInsightsConnectionString": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-monitoring'), '2022-09-01').outputs.applicationInsightsConnectionString.value]"
    },
    "deploymentSummary": {
      "type": "object",
      "value": {
        "message": "Deployment completed successfully!",
        "nextSteps": [
          "[format('1. Visit your Static Web App at: {0}', reference(resourceId('Microsoft.Resources/deployments', 'deploy-staticwebapp'), '2022-09-01').outputs.staticWebAppUrl.value)]",
          "2. Configure GitHub Actions for automated deployments",
          "3. Upload sample data using the provided script",
          "4. Create your first knowledge base in the app"
        ],
        "estimatedMonthlyCost": "[if(equals(parameters('environment'), 'dev'), '$100-150', if(equals(parameters('environment'), 'staging'), '$250-350', '$500+'))]",
        "resources": {
          "search": "[variables('resourceNames').search]",
          "aiServices": "[variables('resourceNames').openai]",
          "storage": "[variables('resourceNames').storage]",
          "foundry": "[format('{0} / {1}', variables('resourceNames').hub, variables('resourceNames').project)]",
          "staticWebApp": "[variables('resourceNames').staticWebApp]",
          "monitoring": "[format('{0} / {1}', variables('resourceNames').logAnalytics, variables('resourceNames').appInsights)]"
        }
      }
    },
    "AZURE_STATIC_WEB_APP_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-staticwebapp'), '2022-09-01').outputs.staticWebAppName.value]"
    },
    "SERVICE_WEB_ENDPOINT_URL": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-staticwebapp'), '2022-09-01').outputs.staticWebAppUrl.value]"
    },
    "AZURE_SEARCH_SERVICE_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-search'), '2022-09-01').outputs.searchServiceName.value]"
    },
    "AZURE_STORAGE_ACCOUNT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-storage'), '2022-09-01').outputs.storageAccountName.value]"
    },
    "AZURE_AI_SERVICES_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.aiServicesName.value]"
    },
    "AZURE_SEARCH_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-search'), '2022-09-01').outputs.searchEndpoint.value]"
    },
    "AZURE_OPENAI_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.aiServicesEndpoint.value]"
    },
    "AZURE_FOUNDRY_PROJECT_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-foundry'), '2022-09-01').outputs.projectEndpoint.value]"
    }
  }
}