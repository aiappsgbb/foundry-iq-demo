name: GBB Demo

on:
  workflow_dispatch:
  # Uncomment the below line to run the workflow on commit
  # push:
  #   # Run when commits are pushed to mainline branch
  #   # Set this to the mainline branch you are using
  #   branches:
  #     - main

# Set this permission if you are using a Federated Credential.
permissions:
  id-token: write
  contents: read

jobs:
  detect-scope:
    runs-on: ubuntu-latest
    outputs:
      target-scope: ${{ steps.detect.outputs.target-scope }}
      resource-group-name: ${{ steps.detect.outputs.resource-group-name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Bicep Target Scope
        id: detect
        run: |
          # Detect target scope from main.bicep
          $bicepFile = 'infra/main.bicep'
          if (Test-Path $bicepFile) {
            $targetScope = Select-String -Path $bicepFile -Pattern 'targetScope\s*=\s*[''"](\w+)[''"]' | ForEach-Object { $_.Matches.Groups[1].Value }
            
            if ($targetScope -eq 'resourceGroup') {
              Write-Output "target-scope=resourceGroup" >> $env:GITHUB_OUTPUT
              Write-Output "Target scope: resourceGroup"
            } elseif ($targetScope -eq 'subscription') {
              Write-Output "target-scope=subscription" >> $env:GITHUB_OUTPUT
              Write-Output "Target scope: subscription"
            } else {
              # Default to subscription if not explicitly set
              Write-Output "target-scope=subscription" >> $env:GITHUB_OUTPUT
              Write-Output "Target scope not found or invalid, defaulting to subscription"
            }
          } else {
            Write-Output "target-scope=subscription" >> $env:GITHUB_OUTPUT
            Write-Output "main.bicep not found, defaulting to subscription"
          }
        shell: pwsh

      - name: Detect Resource Group Name
        id: rg-detect
        if: steps.detect.outputs.target-scope == 'resourceGroup'
        run: |
          # For resourceGroup scope, extract the resource group name from environment or parameters
          $rgName = "${{ vars.AZURE_RESOURCE_GROUP }}"
          if ([string]::IsNullOrEmpty($rgName)) {
            $rgName = "rg-${{ vars.AZURE_ENV_NAME }}"
          }
          Write-Output "resource-group-name=$rgName" >> $env:GITHUB_OUTPUT
          Write-Output "Resource group name: $rgName"
        shell: pwsh

  build:
    needs: detect-scope
    runs-on: ubuntu-latest
    environment: "GBB demo"
    outputs:
      swa-deployment-token: ${{ steps.get-swa-token.outputs.swa-deployment-token }}
    # azd built-in variables.
    # These variables are always set by `azd pipeline config`
    # You can set them as global env (apply to all steps) or you can add them to individual steps' environment
    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      AZURE_RESOURCE_GROUP: ${{ needs.detect-scope.outputs.resource-group-name || format('rg-{0}', vars.AZURE_ENV_NAME) }}
      TARGET_SCOPE: ${{ needs.detect-scope.outputs.target-scope }}
      ## Define the additional variables or secrets that are required globally (provision and deploy)
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # using the install-azd action
      - name: Install azd
        uses: Azure/setup-azd@v2.1.0

      # azd sets up Federated Credential by default. You can remove this step if you are using Client Credentials
      - name: Log in with Azure (Federated Credentials)
        if: ${{ env.AZURE_CLIENT_ID != '' }}
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Log in with azd (Federated Credentials)
        if: ${{ env.AZURE_CLIENT_ID != '' }}
        run: |
          azd auth login `
            --client-id "$Env:AZURE_CLIENT_ID" `
            --federated-credential-provider "github" `
            --tenant-id "$Env:AZURE_TENANT_ID"
        shell: pwsh

      - name: Create Resource Group (if needed)
        if: ${{ env.TARGET_SCOPE == 'resourceGroup' }}
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            RG_EXISTS=$(az group exists --name "$AZURE_RESOURCE_GROUP" --subscription "$AZURE_SUBSCRIPTION_ID")
            
            if [ "$RG_EXISTS" = "true" ]; then
              echo "Resource group '$AZURE_RESOURCE_GROUP' already exists"
            else
              echo "Creating resource group '$AZURE_RESOURCE_GROUP'..."
              az group create \
                --name "$AZURE_RESOURCE_GROUP" \
                --location "$AZURE_LOCATION" \
                --subscription "$AZURE_SUBSCRIPTION_ID"
              echo "Resource group '$AZURE_RESOURCE_GROUP' created successfully"
            fi
        env:
          AZURE_RESOURCE_GROUP: ${{ env.AZURE_RESOURCE_GROUP }}
          AZURE_LOCATION: ${{ env.AZURE_LOCATION }}
          AZURE_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Provision Infrastructure (Subscription Scope)
        if: ${{ env.TARGET_SCOPE == 'subscription' }}
        run: azd provision --no-prompt
        env:
          # uncomment this if you are using infrastructure parameters
          AZD_INITIAL_ENVIRONMENT_CONFIG: ${{ secrets.AZD_INITIAL_ENVIRONMENT_CONFIG }}
          ## Define the additional variables or secrets that are required only for provision

      - name: Provision Infrastructure (Resource Group Scope)
        if: ${{ env.TARGET_SCOPE == 'resourceGroup' }}
        run: |
          azd provision --no-prompt
        env:
          AZURE_RESOURCE_GROUP: ${{ env.AZURE_RESOURCE_GROUP }}
          # uncomment this if you are using infrastructure parameters
          AZD_INITIAL_ENVIRONMENT_CONFIG: ${{ secrets.AZD_INITIAL_ENVIRONMENT_CONFIG }}
          ## Define the additional variables or secrets that are required only for provision

      # Skipping azd deploy - SWA doesn't fully work with azd at this moment
      # Using Azure Static Web Apps deploy action instead (see build_and_deploy job)

      - name: Get SWA Name from azd
        id: get-swa-name
        run: |
          # Get the Static Web App name from azd environment
          SWA_NAME=$(azd env get-value AZURE_STATIC_WEB_APP_NAME)
          
          if [ -z "$SWA_NAME" ]; then
            echo "Error: Could not find AZURE_STATIC_WEB_APP_NAME in azd environment"
            exit 1
          fi
          
          echo "Static Web App name: $SWA_NAME"
          echo "swa-name=$SWA_NAME" >> $GITHUB_OUTPUT
        shell: bash

      - name: Get SWA Deployment Token
        id: get-swa-token
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            SWA_NAME="${{ steps.get-swa-name.outputs.swa-name }}"
            
            echo "Getting deployment token for Static Web App: $SWA_NAME"
            
            # Get deployment token
            DEPLOYMENT_TOKEN=$(az staticwebapp secrets list \
              --name "$SWA_NAME" \
              --resource-group "$AZURE_RESOURCE_GROUP" \
              --query "properties.apiKey" -o tsv)
            
            if [ -z "$DEPLOYMENT_TOKEN" ]; then
              echo "Error: Could not retrieve deployment token"
              exit 1
            fi
            
            # Mask the token in logs
            echo "::add-mask::$DEPLOYMENT_TOKEN"
            echo "swa-deployment-token=$DEPLOYMENT_TOKEN" >> $GITHUB_OUTPUT
            echo "Successfully retrieved SWA deployment token"

  build_and_deploy:
    needs: build
    runs-on: ubuntu-latest
    name: Build and Deploy to SWA
    environment: "GBB demo"
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ needs.build.outputs.swa-deployment-token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/" # App source code path
          api_location: "" # Api source code path - optional
          # For hybrid Next.js apps, leave output_location empty to let SWA's Oryx builder
          # handle the deployment automatically. The ".next/standalone" output is not
          # compatible with SWA's managed hybrid hosting.
          # See: https://learn.microsoft.com/en-us/azure/static-web-apps/deploy-nextjs-hybrid
          output_location: "" # Empty for hybrid Next.js